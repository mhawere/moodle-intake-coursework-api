define("local_courseworkapi/intake_form_injection",["jquery","core/ajax","core/notification"],function(e,t,n){return{init:function(){this.injectIntakeField()},injectIntakeField:function(){var t=this;window.location.pathname.includes("/course/modedit.php")&&e(document).ready(function(){t.waitForFormAndInject()})},waitForFormAndInject:function(){var t=this,n=0,i=function(){n++;var a=e('form[data-form-type="course_module"], form.mform, #mform1'),o=e("#id_general, fieldset:first");if(a.length>0&&o.length>0&&!e("#id_intake_selection").length){var r=e('#id_modulename').val()==="quiz"||e('input[name="modulename"][value="quiz"]').length>0||e(".modtype_quiz").length>0,s=e('#id_modulename').val()==="assign"||e('input[name="modulename"][value="assign"]').length>0||e(".modtype_assign").length>0;(r||s)&&t.loadIntakesAndInject(o)}else n<50&&setTimeout(i,200)};i()},loadIntakesAndInject:function(e){var n=this;t.call([{methodname:"local_courseworkapi_get_all_intakes",args:{activeonly:!0}}])[0].done(function(t){t.intakes&&t.intakes.length>0&&n.createIntakeSection(e,t.intakes)}).fail(function(e){console.log("Failed to load intakes:",e)})},createIntakeSection:function(t,n){var i='<option value="0">No intake selected</option>';n.forEach(function(e){i+='<option value="'+e.id+'">'+e.name+" ("+e.code+")</option>"});var a='<fieldset class="collapsible" id="id_intakeheader"><legend class="ftoggler"><a class="fheader" role="button" aria-controls="id_intakeheader" aria-expanded="false" href="#">Intake Assignment</a></legend><div class="fcontainer"><div class="form-group row fitem"><div class="col-md-3"><label for="id_intake_selection">Assign to Intake</label></div><div class="col-md-9"><select name="intake_selection" id="id_intake_selection" class="form-control">'+i+'</select><div class="form-text text-muted">Select an intake period to associate this coursework with.</div></div></div></div></fieldset>';t.after(a);var o=e('input[name="sesskey"]').val();o||(o=M.cfg.sesskey,e("form").append('<input type="hidden" name="sesskey" value="'+o+'">')),this.setCurrentIntakeValue(),this.attachChangeHandler()},setCurrentIntakeValue:function(){var n=new URLSearchParams(window.location.search),i=n.get("update");i&&t.call([{methodname:"local_courseworkapi_get_current_intake_for_cm",args:{cmid:parseInt(i)}}])[0].done(function(t){t.intakeid&&t.intakeid>0&&e("#id_intake_selection").val(t.intakeid)}).fail(function(e){console.log("Failed to get current intake:",e)})},attachChangeHandler:function(){e("#id_intake_selection").on("change",function(){var t=e(this).val();console.log("Intake selection changed to:",t)})}}});
